<!DOCTYPE html>
<html>
<head>
  <title>Create Issue</title>
</head>
<body>

<link rel="stylesheet" href="/style.css">

<div class="menu-toggle" onclick="toggleMenu()">
  â˜° Menu
</div>

<div class="layout">

  <div class="sidebar" id="sidebar">
   <h2>Club ERP</h2>

   <a href="/">Dashboard</a>
   <a href="/components-page">Components</a>
   <a href="/issue-page">Issue</a>
   <a href="/transactions-page">Transactions</a>
   <a href="/student.html">Student Profile</a>

   <hr>

   <a href="/admin-settings.html">Admin Settings</a>
   <a href="#" onclick="logout()">Logout</a>
 </div>

  <div class="content">
    <h1>Create Issue</h1>

     <div class="card">
     <input id="studentName" placeholder="Student Name">
     <input id="usn" placeholder="USN">
     <input id="phone" placeholder="Phone Number">
     </div>

  <div class="card">
      <div style="position:relative;">

     <input 
      id="componentSearch"
      placeholder="Search component..."
      onkeyup="filterComponents()"
      onclick="showDropdown()"
     >

   <div id="componentDropdown" style="
    position:absolute;
    background:white;
    width:100%;
    max-height:200px;
    overflow-y:auto;
    border:1px solid #ccc;
    display:none;
    z-index:1000;
   ">
  </div>

   </div>
      <input id="quantity" type="number" placeholder="Quantity">
      <button onclick="addToCart()">Add</button>
     </div>

  <div class="card">
     <ul id="cartList"></ul>
     <button onclick="submitIssue()">Submit Issue</button>
     </div>
    
<script>

  let allComponents = [];
  let selectedComponents = null;

let cart = [];

async function loadComponents() {

  const res = await fetch("/components");
  const data = await res.json();

  allComponents = data.filter(c => c.available_quantity > 0);

}

function showDropdown() {
  renderDropdown(allComponents);
  document.getElementById("componentDropdown").style.display = "block";
}

function filterComponents() {

  const query = document.getElementById("componentSearch").value.toLowerCase();

  const filtered = allComponents.filter(c =>
    c.name.toLowerCase().includes(query)
  );

  renderDropdown(filtered);
}

function renderDropdown(list) {

  const dropdown = document.getElementById("componentDropdown");
  dropdown.innerHTML = "";

  list.forEach(c => {

    const item = document.createElement("div");
    item.style.padding = "8px";
    item.style.cursor = "pointer";

    item.innerHTML = `
      ${c.name}
      <span style="float:right;font-size:12px;color:gray;">
        ${c.available_quantity} available
      </span>
    `;

    item.onclick = () => selectComponent(c);

    dropdown.appendChild(item);
  });

}

function selectComponent(component) {

  selectedComponentId = component.id;

  document.getElementById("componentSearch").value = component.name;

  document.getElementById("componentDropdown").style.display = "none";
}

function addToCart() {

  const component_id = selectedComponentId;

  if (!component_id) {
    showToast("Select a component first", false);
    return;
  }

  const quantity = parseInt(document.getElementById("quantity").value);

  if (!quantity || quantity <= 0) {
    showToast("Enter valid quantity", false);
    return;
  }

  cart.push({
    component_id,
    quantity
  });

  showToast("Added to cart");
} 

function renderCart() {
  const list = document.getElementById("cartList");
  list.innerHTML = "";

  cart.forEach((item, index) => {
    list.innerHTML += `
      <li>
        Component ID: ${item.component_id} | Quantity: ${item.quantity}
        <button onclick="removeItem(${index})">Remove</button>
      </li>
    `;
  });
}

function removeItem(index) {
  cart.splice(index, 1);
  renderCart();
}

async function submitIssue() {

  const student_name = document.getElementById("studentName").value.trim();
  const usn = document.getElementById("usn").value.trim();
  const phone = document.getElementById("phone").value.trim();

  if (!student_name || !usn || !phone || cart.length === 0) {
    alert("Fill all fields and add components");
    return;
  }

  const res = await fetch("/create-issue", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      student_name,
      usn,
      phone,
      items: cart
    })
  });

  const data = await res.json();
  showToast(data.message);

  cart = [];
  renderCart();
  loadComponents();
}

loadComponents();

document.addEventListener("click", function(e) {
  if (!e.target.closest("#componentSearch")) {
    document.getElementById("componentDropdown").style.display = "none";
  }
});

</script>

<script>
function toggleMenu() {
  document.getElementById("sidebar").classList.toggle("active");
}
</script>

<div id="toast" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #1e293b;
  color: white;
  padding: 12px 18px;
  border-radius: 8px;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
"></div>

<script>
function showToast(message, success = true) {
  const toast = document.getElementById("toast");
  toast.style.background = success ? "#16a34a" : "#dc2626";
  toast.innerText = message;
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 2500);
}
</script>

<script>
async function logout() {
  await fetch("/logout", { method: "POST" });
  window.location.href = "/login.html";
}
</script>

</body>
</html>